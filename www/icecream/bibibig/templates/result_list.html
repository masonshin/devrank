{% extends "base.html" %}

{% block head %}
    <script src="{{ STATIC_URL }}resources/js/social.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}resources/js/d3.v3.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}resources/js/jquery-scrollto.js"></script>

    <script type="text/javascript">
        $(document).ready(function (){
            var xhr;
            function activePos(who, detail){
                var id = 'social-graph-'+who;

                $("#"+id).empty();
                detail.children().find(".loader").show();

                detail.addClass("pos");
                detail.fadeIn();

                var odd = detail.attr('odd');
                var query = "{{me}}|"+who;
                var color = "#1abc9c";
                if (odd % 2 == 0){ color =  "#f1c40f"; }

                {% if login == True %}
                  if(xhr && xhr.readyState != 4){
                    $("#"+id).empty();
                    detail.children().find(".loader").show();
                    xhr.abort();
                  }
                  xhr = $.ajax({
                    type: "GET",
                    url: "/social.json?users=" + query,
                    success: function(result, status, xhr) {
                        detail.children().find(".loader").fadeOut();
                        $("#"+id).css("background-color", color);

                        var width = $("#"+id).width();
                        var height = 300;

                        social_rel(result, '#' + id, width, height);
                    },
                 });
                {% endif %}
            }

            $('#query').val("{{query}}");
            $(".task").on("click", function(d){
                var task = $(this);
                var who = $(this).attr('id');
                var detail = $(this).parent().find("#detail-"+who);
                var has_pos = detail.hasClass("pos")

                $(".pos").animate(
                    { height: 0, opacity: 0 },
                    'slow',
                    function() {
                        $(this).attr("style","display:none");
                        $(this).removeClass("pos");
                        task.ScrollTo();
                        }
                );

                if (!has_pos){
                    task.ScrollTo({
                        callback: function(){
                            activePos(who, detail);
                        }
                    });
                }

            });
        });
    </script>
{% endblock %}

{% block body %}
<div class='container'>
    <div class='row-fluid'>

        <div class="navbar navbar-fixed-top">
          <div id="result_head" class="navbar-inner">
            <a class="brand" href='/'><img src='{{ STATIC_URL }}images/logo.png'></a>
                {% if login == True %}
                <form id='search_form' class="nav navbar-form pull-left" action="/home">
                    <div class="control-group success">
                        <input type="hidden" name='m' value="{{ me }}"></input>
                        <input placeholder="Enter Keyword" name='q' type="text" id="query" class="search-query" autocomplete="off"> </input>
                    </div>
                </form>
                {% endif %}
                <ul class="nav nav-bar pull-right">
                    {% if login == True %}
                      <li><a href="#">Social Map</a></li>
                      <li><a href="/logout">Logout</a></li>
                    {% else %}
                      <li><a href="/login/github"><i class="icon-github icon-1x"></i> Connect with Github</a></li>
                    {% endif %}
                </ul>
          </div>
        </div>

        <div class="offset2 span8 offset2">
            {% for result in results %}
              {% include "result.html" %}
            {% endfor %}
        </div>

    </div>
</div>
{% endblock %}
